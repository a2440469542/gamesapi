<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>系统数据</title>
    <link rel="stylesheet" href="/static/css/ele/index.css">
    <link rel="stylesheet" href="/static/css/ele/home.css">
    <script src="/static/js/ele/vue.js"></script>
    <script src="/static/js/ele/index.js"></script>
    <script src="/static/js/ele/axios.min.js"></script>
    <script src="/static/js/ele/request.js"></script>
    <script src="/static/js/jquery.js"></script>
</head>
<body>
<div id="app">
    <el-row class="create">
        <el-button type="primary" @click="dialogFormVisible = true">添加渠道</el-button>
    </el-row>
    <template>
        <el-table
                :data="tableData"
                border
                align="center"
                style="width: 100%">
            <el-table-column
                    prop="cid"
                    align="center"
                    label="渠道ID">
            </el-table-column>
            <el-table-column
                    prop="name"
                    align="center"
                    label="渠道名称">
            </el-table-column>
            <el-table-column
                    align="center"
                    label="MENU-Logo">
                <template slot-scope="scope">
                    <img :src="scope.row.icon" style="width: 100px" />
                </template>
            </el-table-column>
            <el-table-column
                    prop="title"
                    align="center"
                    label="网站名称">
            </el-table-column>
            <el-table-column
                    align="center"
                    label="网站logo">
                <template slot-scope="scope">
                    <img :src="scope.row.logo" style="width: 100px" />
                </template>
            </el-table-column>
            <el-table-column
                    align="center"
                    label="前端地址">
                <template slot-scope="scope">
                    {{scope.row.url + '?cid=' + scope.row.cid}}
                </template>
            </el-table-column>
            <el-table-column
                    prop="min_recharge"
                    align="center"
                    label="最低充值">
            </el-table-column>
            <el-table-column
                    prop="min_draw"
                    align="center"
                    label="最低提款">
            </el-table-column>
            <el-table-column
                    prop="ct_multiple"
                    align="center"
                    label="充提倍数">
            </el-table-column>
            <el-table-column
                    fixed="right"
                    label="操作">
                <template slot-scope="scope">
                    <el-button @click="handleUpdate(scope.row)" type="primary" size="small">修改</el-button>
                    <el-button @click="handleDel(scope.row)" type="danger" size="small">删除</el-button>
                </template>
            </el-table-column>
        </el-table>
    </template>
    <el-dialog title="编辑渠道" :visible.sync="dialogFormVisible" :width="'30%'">
        <!--添加-->
        <el-form :model="form" :rules="rules" ref="ruleForm">
            <el-form-item label="渠道名称" :label-width="'150px'" prop="name">
                <el-input v-model="form.name" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="MENU-LOGO" :label-width="'150px'" prop="icon">
                <el-upload
                        class="avatar-uploader"
                        action="/admin/upload/uploader"
                        :show-file-list="false"
                        :headers="{ Authorization: `${getToken()}` }"
                        accept="image/jpg,image/png"
                        :on-success="handleUploadSuccess">
                    <img v-if="form.icon" :src="form.icon" class="avatar">
                    <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
            </el-form-item>
            <el-form-item label="网站名称" :label-width="'150px'" prop="title">
                <el-input v-model="form.title" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="网站logo" :label-width="'150px'" prop="logo">
                <el-upload
                        class="avatar-uploader"
                        action="/admin/upload/uploader"
                        :show-file-list="false"
                        :headers="{ Authorization: `${getToken()}` }"
                        accept="image/jpg,image/png"
                        :on-success="handleUploadSuccess2">
                    <img v-if="form.logo" :src="form.logo" class="avatar">
                    <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
            </el-form-item>
            <el-form-item label="网站地址" :label-width="'150px'" prop="url">
                <el-input v-model="form.url" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="最低充值" :label-width="'150px'" prop="min_recharge">
                <el-input v-model="form.min_recharge" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="最低提款" :label-width="'150px'" prop="min_draw">
                <el-input v-model="form.min_draw" autocomplete="off"></el-input>
            </el-form-item>
            <el-form-item label="充提倍数" :label-width="'150px'" prop="ct_multiple">
                <el-input v-model="form.ct_multiple" autocomplete="off"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer" style="text-align: center;">
            <el-button type="primary"  @click="submitForm('ruleForm')">确 定</el-button>
            <el-button @click="resetForm('ruleForm')">取 消</el-button>
        </div>
    </el-dialog>
</div>
<script>
    var Main = {
        created(){
            this.get_list()
        },
        methods: {
            getToken(){
                return localStorage.getItem('token')
            },
            async get_list(){

                let prams = {
                    page:this.page,
                    limit:this.limit
                };
                const response = await fetchData('/admin/channel/index','post',prams)
                if(response.code === 0){
                    this.tableData = response.data
                }else{
                    this.$message({
                        showClose: true,
                        message: response.msg,
                        type: 'error'
                    });
                }
            },
            handleSizeChange(val) {
                this.limit = val
                this.get_list()
            },
            handleCurrentChange(val) {
                this.page = val;
                this.get_list()
            },
            handleUploadSuccess(res, file){
                if(res.code === 0){
                    console.log(res)
                    this.form.icon = res.data.path;
                    console.log(this.form)
                }else{
                    this.$message({
                        showClose: true,
                        message: res.msg,
                        type: 'error'
                    });
                }
            },
            handleUploadSuccess2(res, file){
                if(res.code === 0){
                    this.form.logo = res.data.path;
                    console.log(this.form)
                }else{
                    this.$message({
                        showClose: true,
                        message: res.msg,
                        type: 'error'
                    });
                }
            },
            handleUpdate(row){
                Object.keys(row).forEach(key => {
                    this.form[key] = row[key];
                });
                this.dialogFormVisible = true
            },
            async handleDel(row){
                let prams={
                    id:row.id
                };
                const response = await fetchData('/admin/channel/del','post',prams)
                if(response.code === 0){
                    this.$message.success(response.msg);
                    this.get_list()
                }else{
                    this.$message.error(response.msg);
                }
            },
            resetForm(formName) {
                this.$refs[formName].resetFields();
                this.form.id = 0
                this.dialogFormVisible = false
            },
            async submitForm(formName) {
                this.$refs[formName].validate(async (valid) => {
                    if (valid) {
                        let prams = this.form
                        const response = await fetchData('/admin/channel/edit','post',prams)
                        if (response.code === 0) {
                            this.$message.success('编辑成功');
                            this.resetForm(formName)
                            this.get_list()
                        } else {
                            this.$message.error(response.msg);
                        }
                    } else {
                        return false;
                    }
                });
            },
        },
        data() {
            return {
                page:1,
                limit:10,
                tableData: [],
                total:0,
                dialogFormVisible: false,
                form: {
                    cid:0,
                    name:'',
                    icon:'',
                    title:'',
                    logo:'',
                    url:'',
                    min_recharge:0,
                    min_draw:0,
                    ct_multiple:1
                },
                rules: {
                    name:[
                        { required: true, message: '请输入分类名称', trigger: 'blur' },
                    ],
                    icon:[
                        { required: true, message: '请上传MENU-LOGO', trigger: 'blur' },
                    ],
                    title:[
                        { required: true, message: '请输入网站名称', trigger: 'blur' },
                    ],
                    logo:[
                        { required: true, message: '请上传logo', trigger: 'blur' },
                    ],
                    url:[
                        { required: true, message: '请输入前端地址', trigger: 'blur' },
                    ],
                    min_recharge:[
                        { required: true, message: '最低充值', trigger: 'blur' },
                    ],
                    min_draw:[
                        { required: true, message: '最低存款', trigger: 'blur' },
                    ],
                    ct_multiple:[
                        { required: true, message: '充提投注倍数', trigger: 'blur' },
                    ]
                },
            }
        }
    }
    var Ctor = Vue.extend(Main)
    new Ctor().$mount('#app')
</script>
</body>
</html>